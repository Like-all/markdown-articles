Сборка пакетов для Debian и Ubuntu из исходных кодов: от скелета до репозиториев
================================================================================

## Содержание

- []()


### Определитесь, нужна ли вам сборка пакета из исходников

Я не буду здесь рассказывать для чего нужны пакеты - если вы заинтересовались их сборкой, то примерно представляете, что они такое и с чем их едят. Первый вопрос, который стоит себе задать при появлении желания собрать пакет с какой-нибудь программой, библиотекой или документацией - а точно ли мне нужно этим заниматься? Не проделал ли кто-нибудь уже работу за меня? В 95% случаев желаемый пакет найдётся для Ubuntu в [Launchpad](https://launchpad.net/); у Debian нет такой мощной инфраструктуры, поэтому дела там обстоят немного хуже, но не совсем плохо - есть [список альтернативных репозиториев](https://wiki.debian.org/ru/UnofficialRepositories). Кроме того, разработчики некоторого программного обеспечения предоставляют свои репозитории с готовым к употреблению софтом, например, система мониторинга [Sensu](http://sensuapp.org/). Ещё раз для закрепления: **не делайте уже проделанную кем-либо работу, если конечной целью является установка пакета и дальнейшее его использование**. Если же вы желаете научиться собирать пакеты, то переходите к следующим параграфам.

### Подготовка к сборке пакета

Хорошим подспорьем в подготовке к сборке будет уже готовый пример. Возьмём для этого программу [Lightspeed](https://packages.debian.org/search?keywords=lightspeed&searchon=names&suite=all&section=all), которая имеется в официальных репозиториях Debian и Ubuntu. Это обычная графическая программа, написанная на языке C и использующая скрипт `./configure` для генерации `Makefile`. Помимо самих пакетов, в официальных репозиториях распространяются также и их исходные коды. Для получения исходных кодов `Lightspeed` перейдём в любую удобную нам для сборки пакета директорию и выполним команду `apt-get source lightspeed`. В результате мы получим три файла и одну директорию: файл с упакованным diff исходников(`*.diff.gz`), файл с подписанным PGP-ключом описанием пакета(`.dsc`), файл с упакованным оригинальным исходным кодом(`*.orig.tar.gz`) и директория с подготовленными к сборке исходниками. Внутри неё есть директория `debian`, которая по факту является описанием процесса сборки. Забегая немного вперёд, скажу что практически в любой экостистеме централизованного распространения программного обеспечения есть понятие *сборочные зависимости*. Это программы, необходимые исключительно для превращения исходного кода в нечто готовое для употребления. Для установки сборочных зависимостей программы `Lightspeed` выполним команду `sudo apt-get build-dep lightspeed`. Теперь же исследуем содержимое директории `debian`.

#### Файл control

Пожалуй, это основной файл, руководящий процессом сборки. Основнее только `rules`, но до него мы ещё дойдём. В файле `control` описаны информационные сущности пакета: что, для чего, от чего зависим, какие пакеты собираем(да, из одного дерева исходников можно собирать несколько пакетов) и так далее. Первой в описании всегда следует директива `Source` и всё, что за ней следует. Здесь мы видим несколько пунктов:

+ `Source`: имя дерева исходных кодов
+ `Maintainer`: имя и адрес электронной почты ответственного за поддержку пакета человека. Чаще всего в этом пункте можно найти список рассылки.
+ `Uploaders`: имена и адреса помощников мейнтейнера. Те, кто имеют право загрузки в репозиторий.
+ `Changed-By`: имена и адреса тех, кто подготовил изменения в текущей версии пакета
+ `Section`: область применения пакета, например *misc*, *net*, *science*. Полный список секций есть [тут](https://www.debian.org/doc/debian-policy/ch-archive.html#s-subsections)
+ `Priority`: степень "важности" или "значимости" пакета. Короче, приоритет. Они бывают разные.
    + `required`: пакеты необходимы для нормального функционирования системы
    + `important`: важные программы, без которых операционная система не будет восприниматься как Unix-like система
    + `standard`: пакеты, устанавливаемые в базовой поставке ОС, если пользователь не указал иное
    + `optional`: всё ПО, которое может захотеть установить пользователь, не имеющий специальных требований; пакеты c приоритетом `optional` **не должны** конфликтовать друг с другом
    + `extra`: пакеты, не удовлетворяющие указанным выше условиям
+ `Homepage`: тут всё понятно, это домашняя страничка проекта
+ `Vcs-*`: адрес репозитория
+ `Vcs-Browser`: веб-страница с репозиторием
+ `Standards-Version`: версия стандарта, описываемого в политике Debian

Далее следуют директивы, описывающие бинарные пакеты, собираемые из исходных кодов:

+ `Package`: имя бинарного пакета, то, что мы пишем после `apt-get install`
+ `Architecture`: целевая архитектура операционной системы
    + обычно, достаточно использовать `any`, что означает, что итоговый бинарный пакет будет собран под ту архитектуру CPU и ядро ОС(напомню, что Debian(пока ещё) - это не только GNU/Linux), в которой, собственно, и осуществлялась сборка
    + также возможно задать ограничение по ядру OC, например `linux-any`, `kfreebsd-any`, и так далее
    + если пакет содержит программы, написанные на интерпретируемых языках программирования(Ruby, Python, Javascript) и не содержащих нативных модулей, документацию, иконки, темы, шрифты или что либо ещё, что не использует скомпилированные под определённую архитектуру процессора программы, то достаточно использовать архитектуру `all`
+ `Essential`: булево значение, указывающее, что пакет является необходимым для функционирования системы; пакетный менеджер будет отвергать попытки удаления этого пакета
+ Поля, управляющие взаимоотношениями пакетов: в этих полях указываются зависимости, конфликты и прочие аспекты взаимодействия пакетов. Необходимо указывать имена пакетов и их версии через запятую. Зависимости могут быть как жёсткими, так и мягкими. Это поведение задаётся операторами `<<`(строго меньше), `<=`(меньше или равно), `=`(равно), `>=`(больше или равно), `>>`(строго больше)
    + `Depends`: указывает на явную и абсолютную зависимость от другого пакета; это означает, что наш пакет не будет установлен и настроен, пока не будут установлены и настроены все пакеты, указанные через запятую в этой строке
    + `Recommends`: строгая, но не абсолютная зависимость; пакеты, указанные в этой строке, по умолчанию устанавливаются в ОС вместе с нашим пакетом, это поведение регулируется настройкой пакетного менеджера
    + `Suggests`: пакеты, указанные в этой строке, улучшают работу нашего пакета, но не являются необходимыми для нормальной работы; они предлагаются пользователю во время установки
    + `Enhances`: эта строка указывает, каким пакетам "будет лучше", если будет установлен наш пакет, можно рассматривать эту строку как обратную версию строки `Suggests`
    + `Pre-Depends`: эта строка похожа на `Depends`, но есть одно различие: наш пакет не начнёт устанавливаться ровно до тех пор, пока не будут установлены и сконфигурированы пакеты в этой строке
    + `Breaks`: 
    + `Conflicts`: наш пакет не может быть установлен одновременно с перечисленными в этой строке пакетами; при установке всё перечисленное будет **удалено**
    + `Provides`: обозначение того, что данный пакет *предоставляет* какой-то другой пакет, другими словами наш пакет становится *виртуальным пакетом*; **важно: виртуальные пакеты не работают, если у какого-то другого пакета имеется зависимость от конкретной версии предоставляемого пакета**. То есть, если у нас в системе есть пакет, скажем, `relativistic-speed`, который предоставляет в системе `lightspeed`, а мы хотим установить пакет `lightspeed-super-cool-plugins`, который зависит от `lightspeed` версии `1.1`, то пакет с плагинами не установится и `apt-get` выдаст ошибку. Если бы `lightspeed-super-cool-plugins` зависел от `lightspeed` без указания конкретной версии, то плагины установились бы нормально. Это явление - самая большая печаль в экосистеме Debian.
    + `Replaces`: наш пакет предоставляет замену для перечисленных в этой строке пакетов
+ `Description`: описание нашего пакета; существует два типа описаний: краткое, которое выдаётся в списке пакетов(например, при вызове `apt-cache search`), и длинное, которое выдаётся при просмотре полного описания пакета(`apt-cache show`); краткое описание пишется в первой строке, длинное описание - в последующих строках, отбитых одним пробелом от начала

#### Файл rules

#### Файл changelog

#### Файлы .
